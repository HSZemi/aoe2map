<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/aoe2maps.css">

    <title>Create a map pack</title>
    <style>
        .active {
            border-width: .2rem;
            border-color: aliceblue;
        }

        body {
            padding-top: 1rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="col-md-6 offset-md-3">
            <h1>Create a map pack</h1>
            <div class="dropzone">
                <div class="card" id="target">
                    <div class="card-body" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" ondragleave="dragLeaveHandler(event);"
                        style="min-height: 20rem;">
                        <div id="filelist"></div>
                        <div class="text-center">Drag and drop .rms map files here</div>
                    </div>
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn btn-primary btn-block" onclick="getdata();">Generate and download map pack</button>
            </div>
        </div>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="js/bootstrap.min.js"></script>
    <script type="text/javascript">

        window.addEventListener("dragover", function (e) {
            e = e || event;
            e.preventDefault();
        }, false);
        window.addEventListener("drop", function (e) {
            e = e || event;
            e.preventDefault();
        }, false);

        function dropHandler(ev) {
            // Prevent default behavior (Prevent file from being opened)
            ev.preventDefault();

            if (ev.dataTransfer.items) {
                // Use DataTransferItemList interface to access the file(s)
                for (var i = 0; i < ev.dataTransfer.items.length; i++) {
                    // If dropped items aren't files, reject them
                    if (ev.dataTransfer.items[i].kind === 'file') {
                        var file = ev.dataTransfer.items[i].getAsFile();
                        handleRmsFile(file);
                    }
                }
            } else {
                // Use DataTransfer interface to access the file(s)
                for (var i = 0; i < ev.dataTransfer.files.length; i++) {
                    let file = ev.dataTransfer.files[i];
                    handleRmsFile(file);
                }
            }

            // Pass event to removeDragData for cleanup
            removeDragData(ev)
        }

        function handleRmsFile(file) {
            if (file.name.endsWith(".rms")) {
                let reader = new FileReader();
                reader.onload = function (e) {
                    let contents = e.target.result;
                    $('<div class="btn btn-secondary btn-block databutton">' + file.name + '</div>').appendTo('#filelist').data('map', contents);
                }
                reader.readAsText(file);
            } else {
                alert(file.name + " is not a .rms file");
            }
        }

        function getdata() {
            let allButtons = $('.databutton');
            wholedata = 'start_random\n';
            let chances = getChances(allButtons.length);
            for (let i = 0; i < allButtons.length; i++) {
                wholedata += "percent_chance " + chances[i] + " #define " + marker(i) + "\n"
            }
            wholedata += 'end_random\n';
            allButtons.each(function (i, it) {
                let ifVariant = "elseif";
                if (i == 0) {
                    ifVariant = "if";
                }
                wholedata += "\n\n" + ifVariant + " " + marker(i) + "\n\n" + $(it).data('map');
            });
            wholedata += "\n\nendif";
            download("mappack.rms", wholedata);
        }

        function getChances(amount) {
            let a = [];
            let sum = 0;
            for (let i = 0; i < amount - 1; i++) {
                percentage = Math.floor(100 / amount);
                a.push(percentage);
                sum += percentage;
            }
            a.push(100 - sum);
            return a;
        }

        function marker(amount) {
            let m = "MAPPACK_MARKER_X";
            for (let i = 0; i < amount; i++) {
                m += "X";
            }
            return m;
        }

        function dragOverHandler(event) {
            $('#target').addClass('active');
        }

        function dragLeaveHandler(event) {
            $('#target').removeClass('active');
        }

        function removeDragData(ev) {
            if (ev.dataTransfer.items) {
                // Use DataTransferItemList interface to remove the drag data
                ev.dataTransfer.items.clear();
            } else {
                // Use DataTransfer interface to remove the drag data
                ev.dataTransfer.clearData();
            }
            dragLeaveHandler(ev);
        }

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }
    </script>
</body>

</html>